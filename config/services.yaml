# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices/configuration.html#application-related-configuration
parameters:
  env(CORS_ALLOW_ORIGIN): "^https?://localhost(:[0-9]+)?$"
  env(SMC_DATABASE): ""
  env(SMC_MAILER_TO): ""
  env(SMC_MAILER_FROM): ""
  env(SMC_MAILER): "smtp://null"
  env(SMC_URL): ""
  env(SMC_KYC_MIRAKL_CUSTOM_FIELD): "stripe-url"
  env(SMC_ENABLE_TRANSFERS): false
  env(SMC_ENABLE_REFUNDS): false
  env(SMC_KYC_REDIRECT_URL): "%env(SMC_MIRAKL_URL)%/mmp/shop/account/shop"
  env(SMC_KYC_PREFILL_FORM): false
  env(SMC_WEBHOOK_ENABLE_ALERTS): true
  env(SMC_WEBHOOK_ALERTS_DELAY): 10
  env(SMC_WEBHOOK_URL): ""

  app.base_host: "%env(SMC_URL)%"
  app.stripe.client_id: "%env(SMC_STRIPE_CLIENT_ID)%"
  app.stripe.client_secret: "%env(SMC_STRIPE_API_KEY)%"
  app.stripe.webhook_secret: "%env(SMC_STRIPE_WEBHOOK_SECRET)%"
  app.stripe.prefill_onboarding: "%env(bool:SMC_KYC_PREFILL_FORM)%"
  app.stripe.enables_auto_transfer_creation: "%env(bool:SMC_ENABLE_TRANSFERS)%"
  app.stripe.enables_auto_refund_creation: "%env(bool:SMC_ENABLE_REFUNDS)%"
  app.mirakl.api_key: "%env(SMC_MIRAKL_API_KEY)%"
  app.mirakl.host_name: "%env(SMC_MIRAKL_URL)%"
  app.mirakl.stripe_custom_field_code: "%env(SMC_KYC_MIRAKL_CUSTOM_FIELD)%"
  app.redirect.onboarding: "%env(SMC_KYC_REDIRECT_URL)%"
  app.operator.notification_url: "%env(SMC_WEBHOOK_URL)%"
  app.mailer.technical: "%env(SMC_MAILER_TO)%"
  app.mailer.technical_from: "%env(SMC_MAILER_FROM)%"
  router.request_context.host: "%env(SMC_URL)%"
  router.request_context.scheme: 'https'
  app.endpoint_down.mail_notification: "%env(bool:SMC_WEBHOOK_ENABLE_ALERTS)%"
  app.endpoint_down.mail_notification_throttle: "%env(int:SMC_WEBHOOK_ALERTS_DELAY)%"
  app.mirakl.metadata_order_id_field_name: "%env(MIRAKL_METADATA_ORDER_ID)%"

services:
  # default configuration for services in *this* file
  _defaults:
    autowire: true # Automatically injects dependencies in your services.
    autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.
    bind:
      $stripeClientId: "%app.stripe.client_id%"
      $stripeClientSecret: "%app.stripe.client_secret%"
      $webhookSecret: "%app.stripe.webhook_secret%"
      $skipAutoTransferCreation: "%app.stripe.enables_auto_transfer_creation%"
      $stripePrefillOnboarding: "%app.stripe.prefill_onboarding%"

      $miraklApiKey: "%app.mirakl.api_key%"
      $miraklHostName: "%app.mirakl.host_name%"
      $customFieldCode: "%app.mirakl.stripe_custom_field_code%"
      $enablesAutoTransferCreation: "%app.stripe.enables_auto_transfer_creation%"
      $enablesAutoRefundCreation: "%app.stripe.enables_auto_refund_creation%"
      $redirectOnboarding: "%app.redirect.onboarding%"
      $operatorNotificationUrl: "%app.operator.notification_url%"
      $metadataOrderIdFieldName: "%app.mirakl.metadata_order_id_field_name%"

      $endpointDownMailNotification: "%app.endpoint_down.mail_notification%"
      $endpointDownMailNotificationThrottleDelay: "%app.endpoint_down.mail_notification_throttle%"
      $technicalEmail: "%app.mailer.technical%"
      $technicalEmailFrom: "%app.mailer.technical_from%"
      $baseHostOverride: "%app.base_host%"

  # makes classes in src/ available to be used as services
  # this creates a service per class whose id is the fully-qualified class name
  App\:
    resource: "../src/*"
    exclude: "../src/{DependencyInjection,Entity,Migrations,Monolog,Tests,Kernel.php}"

  # controllers are imported separately to make sure services can be injected
  # as action arguments even if you don't extend any base controller class
  App\Controller\:
    resource: "../src/Controller"
    tags: ["controller.service_arguments"]

  App\EventListener\SendFailedOperationToAlertingQueue:
    tags:
      - {name: 'doctrine.event_listener', event: 'postPersist'}
      - {name: 'doctrine.event_listener', event: 'postUpdate'}

  get_set_method_normalizer:
    class: Symfony\Component\Serializer\Normalizer\GetSetMethodNormalizer
    public: false
    tags:
      - { name: "serializer.normalizer", priority: -950 } # ObjectNormalizer is priority -1000

  symfony_mailer_monolog.mail_message_factory:
    class: App\Factory\EmailFactory
    public: false
    lazy: true
    autowire: false
    arguments:
      $fromEmail: '%env(SMC_MAILER_FROM)%'
      $toEmail:   '%env(SMC_MAILER_TO)%'
      $subject:    '[Stripe-Mirakl] An Error Occurred! %%message%%'

  symfony_mailer_monolog:
    class: App\Monolog\Handler\SymfonyMailerHandler
    public: false
    lazy: true
    autowire: false
    calls:
      - method: setFormatter
        arguments:
            - '@monolog.formatter.html'
    arguments:
      $mailer: '@mailer'
      $messageFactory: '@symfony_mailer_monolog.mail_message_factory'
      $level: 'warning'
      $bubble: true
